#!/usr/bin/env bash

set -euo pipefail
shopt -s nullglob

readonly SCRIPT_NAME="ai-bootstrap"
readonly PROFILE_GENERAL="general"
readonly RULES_DIR_RELATIVE=".roo/rules"
readonly RULE_CRITICAL_FILE="AA-CRITICAL-INSTRUCTION.md"

declare -a BASE_PATHS=(
  "AGENTS.md"
  ".gemini/styleguide.md"
  "$RULES_DIR_RELATIVE/$RULE_CRITICAL_FILE"
  "$RULES_DIR_RELATIVE/$PROFILE_GENERAL.md"
)

declare -a PROFILE_ARGS=()
declare -a AVAILABLE_PROFILES=()
declare -a SELECTED_PROFILES=()
declare -a SELECTED_PATHS=()

usage() {
  cat <<'EOF'
Usage:
  ai-bootstrap [profile ...] [options]

Profiles:
  Auto-discovered from:
  - .roo/rules/*.md (excluding general.md and AA-CRITICAL-INSTRUCTION.md)
  - docs_<profile>/ directories

Options:
  -f, --force             Overwrite existing files in the target project.
  -n, --dry-run           Show planned actions without writing files.
      --symlink           Symlink mode (default).
      --sim-link          Alias for --symlink.
      --no-symlink        Copy files instead of symlinking.
      --no-sim-link       Alias for --no-symlink.
      --list-profiles     Print discovered profile names and exit.
      --source <path>     Override template source directory.
  -h, --help              Show this help text.

Examples:
  ai-bootstrap
  ai-bootstrap node
  ai-bootstrap flutter node
  ai-bootstrap flutter node --no-symlink
  ai-bootstrap --dry-run --list-profiles
EOF
}

log_line() {
  printf '%s\n' "$1"
}

error_exit() {
  printf 'Error: %s\n' "$1" >&2
  exit 1
}

array_contains() {
  local needle="$1"
  shift

  local item
  for item in "$@"; do
    if [[ "$item" == "$needle" ]]; then
      return 0
    fi
  done

  return 1
}

join_by() {
  local separator="$1"
  shift

  local output=""
  local item
  for item in "$@"; do
    if [[ -z "$output" ]]; then
      output="$item"
      continue
    fi
    output="$output$separator$item"
  done

  printf '%s' "$output"
}

# Resolve the directory of this script even when executed through a symlink.
resolve_script_dir() {
  local source_path="${BASH_SOURCE[0]}"
  while [ -L "$source_path" ]; do
    local source_dir
    source_dir="$(cd -P "$(dirname "$source_path")" && pwd)"
    source_path="$(readlink "$source_path")"
    if [[ "$source_path" != /* ]]; then
      source_path="$source_dir/$source_path"
    fi
  done

  cd -P "$(dirname "$source_path")" && pwd
}

parse_args() {
  FORCE_OVERWRITE=0
  DRY_RUN=0
  USE_SYMLINK=1
  LIST_PROFILES_ONLY=0
  SOURCE_OVERRIDE=""
  PROFILE_ARGS=()

  while (($# > 0)); do
    case "$1" in
      -f | --force)
        FORCE_OVERWRITE=1
        ;;
      -n | --dry-run)
        DRY_RUN=1
        ;;
      --symlink | --sim-link)
        USE_SYMLINK=1
        ;;
      --no-symlink | --no-sim-link)
        USE_SYMLINK=0
        ;;
      --list-profiles)
        LIST_PROFILES_ONLY=1
        ;;
      --source)
        if (($# < 2)); then
          error_exit "--source requires a directory path."
        fi
        SOURCE_OVERRIDE="$2"
        shift
        ;;
      -h | --help)
        usage
        exit 0
        ;;
      --)
        shift
        while (($# > 0)); do
          PROFILE_ARGS+=("$1")
          shift
        done
        break
        ;;
      -*)
        error_exit "Unknown option: $1"
        ;;
      *)
        PROFILE_ARGS+=("$1")
        ;;
    esac
    shift
  done
}

resolve_template_root() {
  local script_dir
  script_dir="$(resolve_script_dir)"

  if [[ -z "$SOURCE_OVERRIDE" ]]; then
    TEMPLATE_ROOT="$script_dir"
    return
  fi

  if [[ ! -d "$SOURCE_OVERRIDE" ]]; then
    error_exit "--source path does not exist: $SOURCE_OVERRIDE"
  fi

  TEMPLATE_ROOT="$(cd "$SOURCE_OVERRIDE" && pwd -P)"
}

discover_available_profiles() {
  AVAILABLE_PROFILES=()

  local rules_dir="$TEMPLATE_ROOT/$RULES_DIR_RELATIVE"
  local path

  if [[ -d "$rules_dir" ]]; then
    for path in "$rules_dir"/*.md; do
      if [[ ! -e "$path" ]]; then
        continue
      fi

      local filename
      filename="$(basename "$path")"

      local profile
      profile="${filename%.md}"

      if [[ "$profile" == "$PROFILE_GENERAL" || "$filename" == "$RULE_CRITICAL_FILE" ]]; then
        continue
      fi

      if ((${#AVAILABLE_PROFILES[@]} == 0)) || ! array_contains "$profile" "${AVAILABLE_PROFILES[@]}"; then
        AVAILABLE_PROFILES+=("$profile")
      fi
    done
  fi

  for path in "$TEMPLATE_ROOT"/docs_*; do
    if [[ ! -d "$path" ]]; then
      continue
    fi

    local docs_profile
    docs_profile="$(basename "$path")"
    docs_profile="${docs_profile#docs_}"

    if [[ -z "$docs_profile" ]]; then
      continue
    fi

    if ((${#AVAILABLE_PROFILES[@]} == 0)) || ! array_contains "$docs_profile" "${AVAILABLE_PROFILES[@]}"; then
      AVAILABLE_PROFILES+=("$docs_profile")
    fi
  done
}

print_available_profiles() {
  log_line "Discovered profiles:"

  if ((${#AVAILABLE_PROFILES[@]} == 0)); then
    log_line "  (none)"
    return
  fi

  local profile
  for profile in "${AVAILABLE_PROFILES[@]}"; do
    log_line "  - $profile"
  done
}

build_selected_profiles() {
  SELECTED_PROFILES=()

  if ((${#PROFILE_ARGS[@]} == 0)); then
    return
  fi

  local profile
  for profile in "${PROFILE_ARGS[@]}"; do
    if [[ "$profile" == "$PROFILE_GENERAL" ]]; then
      continue
    fi

    if ((${#AVAILABLE_PROFILES[@]} == 0)) || ! array_contains "$profile" "${AVAILABLE_PROFILES[@]}"; then
      local discovered_display
      if ((${#AVAILABLE_PROFILES[@]} == 0)); then
        discovered_display="(none)"
      else
        discovered_display="$(join_by ', ' "${AVAILABLE_PROFILES[@]}")"
      fi
      error_exit "Unknown profile '$profile'. Discovered profiles: $discovered_display"
    fi

    if ((${#SELECTED_PROFILES[@]} == 0)) || ! array_contains "$profile" "${SELECTED_PROFILES[@]}"; then
      SELECTED_PROFILES+=("$profile")
    fi
  done
}

append_path_if_exists() {
  local relative_path="$1"
  local absolute_path="$TEMPLATE_ROOT/$relative_path"

  if [[ ! -e "$absolute_path" ]]; then
    return
  fi

  if ((${#SELECTED_PATHS[@]} > 0)) && array_contains "$relative_path" "${SELECTED_PATHS[@]}"; then
    return
  fi

  SELECTED_PATHS+=("$relative_path")
}

build_selected_paths() {
  SELECTED_PATHS=()

  local base_path
  for base_path in "${BASE_PATHS[@]}"; do
    append_path_if_exists "$base_path"
  done

  local profile
  if ((${#SELECTED_PROFILES[@]} == 0)); then
    return
  fi

  for profile in "${SELECTED_PROFILES[@]}"; do
    append_path_if_exists "$RULES_DIR_RELATIVE/$profile.md"
    append_path_if_exists "docs_$profile"
  done
}

copy_item() {
  local source_path="$1"
  local target_path="$2"

  if [[ -d "$source_path" ]]; then
    cp -R "$source_path" "$target_path"
    return
  fi

  cp -f "$source_path" "$target_path"
}

apply_item() {
  local relative_path="$1"
  local source_path="$TEMPLATE_ROOT/$relative_path"
  local target_path="$TARGET_ROOT/$relative_path"

  if [[ ! -e "$source_path" ]]; then
    log_line "missing template: $relative_path"
    MISSING_COUNT=$((MISSING_COUNT + 1))
    return
  fi

  local target_exists=0
  if [[ -e "$target_path" || -L "$target_path" ]]; then
    target_exists=1
  fi

  if [[ "$target_exists" -eq 1 && "$FORCE_OVERWRITE" -eq 0 ]]; then
    log_line "skip    $relative_path (already exists)"
    SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
    return
  fi

  local action_verb="copy"
  if [[ "$USE_SYMLINK" -eq 1 ]]; then
    action_verb="link"
  fi

  if [[ "$DRY_RUN" -eq 1 ]]; then
    if [[ "$target_exists" -eq 1 ]]; then
      log_line "would overwrite ($action_verb) $relative_path"
    else
      log_line "would $action_verb            $relative_path"
    fi
    COPIED_COUNT=$((COPIED_COUNT + 1))
    return
  fi

  mkdir -p "$(dirname "$target_path")"

  if [[ "$target_exists" -eq 1 && "$FORCE_OVERWRITE" -eq 1 ]]; then
    rm -rf "$target_path"
  fi

  if [[ "$USE_SYMLINK" -eq 1 ]]; then
    ln -s "$source_path" "$target_path"
    log_line "linked  $relative_path"
    COPIED_COUNT=$((COPIED_COUNT + 1))
    return
  fi

  copy_item "$source_path" "$target_path"
  log_line "copied  $relative_path"
  COPIED_COUNT=$((COPIED_COUNT + 1))
}

main() {
  parse_args "$@"
  resolve_template_root

  if [[ ! -f "$TEMPLATE_ROOT/AGENTS.md" ]]; then
    error_exit "Template root does not look correct: $TEMPLATE_ROOT"
  fi

  discover_available_profiles

  if [[ "$LIST_PROFILES_ONLY" -eq 1 ]]; then
    print_available_profiles
    exit 0
  fi

  build_selected_profiles
  build_selected_paths

  TARGET_ROOT="$(pwd -P)"
  COPIED_COUNT=0
  SKIPPED_COUNT=0
  MISSING_COUNT=0

  local mode_display="copy"
  if [[ "$USE_SYMLINK" -eq 1 ]]; then
    mode_display="symlink"
  fi

  local profile_display="$PROFILE_GENERAL"
  if ((${#SELECTED_PROFILES[@]} > 0)); then
    profile_display="$PROFILE_GENERAL + $(join_by ', ' "${SELECTED_PROFILES[@]}")"
  fi

  log_line "Running $SCRIPT_NAME"
  log_line "profiles: $profile_display"
  log_line "mode:     $mode_display"
  log_line "source:   $TEMPLATE_ROOT"
  log_line "target:   $TARGET_ROOT"
  log_line ""

  local relative_path
  for relative_path in "${SELECTED_PATHS[@]}"; do
    apply_item "$relative_path"
  done

  log_line ""
  log_line "summary: copied=$COPIED_COUNT skipped=$SKIPPED_COUNT missing_templates=$MISSING_COUNT"
  if [[ "$DRY_RUN" -eq 1 ]]; then
    log_line "dry run only: no files were written."
  fi
}

main "$@"
